/* * * * * * * * *
 *  infinity.js  *
 * Version 0.3.1 *
 * License:  MIT *
 * SimonWaldherr *
 * * * * * * * * */

var infinityAjax=function(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l;for(h="",i=new Date,e=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):XMLHttpRequest&&new XMLHttpRequest||null,f=window.setTimeout(function(){e.abort()},6e3),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&(clearTimeout(f),j=new Date,200!==e.status?d({element:a,response:{},duration:j.getTime()-i.getTime(),status:!1}):(d({element:a,response:JSON.parse(e.responseText),duration:j.getTime()-i.getTime(),status:!0}),"function"==typeof infinityAfterAjax&&infinityAfterAjax()))},k=Object.keys(c),l=0;l<k.length;l++)0!==l&&(h+="&"),h+=k[l]+"="+c[k[l]];g=-1!==b.indexOf("?")?b+"&rt="+i.getTime():b+"?rt="+i.getTime(),a.setAttribute("data-loading","true"),e.open("POST",g,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send(h)};Object.prototype.infinityFirst=function(a){"use strict";var b,c;infinityAjax(this,this.getAttribute("data-url"),{height:this.offsetHeight},function(d){if(b=document.createElement("div"),d.element.setAttribute("data-earliest",d.response.earliest),d.element.setAttribute("data-latest",d.response.latest),void 0!==d.response.classname&&(b.className=d.response.classname),void 0!==d.response.id&&(b.id=d.response.id),1!==d.response.itemscount)for(c=0;c<d.response.itemscount;c++)b=document.createElement("div"),void 0!==d.response.items[c].classname&&(b.className=d.response.items[c].classname),void 0!==d.response.items[c].id&&(b.id=d.response.items[c].id),b.innerHTML='<p class="distime" data-time="'+d.response.items[c].date+'">'+d.response.items[c].date+"</p><div>"+d.response.items[c].html+"</div>",d.element.appendChild(b);else b.innerHTML='<p class="distime" data-time="'+d.response.date+'">'+d.response.date+"</p><div>"+d.response.html+"</div>",d.element.appendChild(b);d.element.setAttribute("data-loading","false"),"function"==typeof a&&a()})},Object.prototype.infinityAppend=function(){"use strict";var a;infinityAjax(this,this.getAttribute("data-url"),{latest:this.getAttribute("data-latest")},function(b){a=document.createElement("div"),b.element.setAttribute("data-latest",b.response.latest),void 0!==b.response.classname&&(a.className=b.response.classname),void 0!==b.response.classname&&(a.id=b.response.id),a.innerHTML='<p class="distime" data-time="'+b.response.date+'">'+b.response.date+"</p><div>"+b.response.html+"</div>",b.element.appendChild(a),b.element.setAttribute("data-loading","false")})},Object.prototype.infinityPrepend=function(){"use strict";var a,b,c,d,e;infinityAjax(this,this.getAttribute("data-url"),{earliest:this.getAttribute("data-earliest")},function(f){for(e=document.createElement("div"),f.element.setAttribute("data-earliest",f.response.earliest),void 0!==f.response.classname&&(e.className=f.response.classname),void 0!==f.response.classname&&(e.id=f.response.id),e.innerHTML='<p class="distime" data-time="'+f.response.date+'">'+f.response.date+"</p><div>"+f.response.html+"</div>",a=0,b=0,c=f.element.scrollTop,d=0;d<f.element.children.length;d++)b+=f.element.children[d].clientHeight;for(f.element.insertBefore(e,f.element.firstChild),f.element.setAttribute("data-loading","false"),a=0,d=0;d<f.element.children.length;d++)a+=f.element.children[d].clientHeight;f.element.scrollTop=c+a-b})};var reloadOnScroll=function(a){"use strict";var b,c=a.scrollTop,d=0;for(b=0;b<a.children.length;b++)d+=a.children[b].clientHeight;return"true"===document.body.getAttribute("data-scrolling")||"true"===a.getAttribute("data-loading")?!1:c<a.parentNode.clientHeight/2?(a.infinityPrepend(),!0):c>d-a.parentNode.clientHeight-a.parentNode.clientHeight/2?(a.infinityAppend(),!0):!1};Object.prototype.infinityinit=function(){"use strict";var a=this;a.onscroll=function(){var b=document.createEvent("Event"),c=!1;c=reloadOnScroll(a),c!==!1&&(a.setAttribute("data-newdate",c),b?(b.initEvent("infinity",!1,!1),a.dispatchEvent(b)):(b.initEvent("infinity",!1,!1),b.target=a,a.dispatchEvent(b)))}};